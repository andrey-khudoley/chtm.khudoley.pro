# Miniapp Video Service - Архитектура проекта

**Версия:** 1.1.0  
**Дата обновления:** 2025-10-04  
**Статус:** В разработке

## Описание

Сервис для отображения видео-записей внутри miniapp приложений Telegram с веб-версией для браузеров.

## Структура проекта

```
/
├── index.tsx                      # Корневой роут с редиректом на актуальную версию
├── lib/                           # Библиотеки и утилиты
│   ├── debug.lib.tsx             # Debug класс для логирования
│   └── debug.repo.ts             # Репозиторий для работы с настройками Debug
├── tables/v1/                     # База данных версии v1
│   └── settings.table            # Таблица глобальных настроек сервиса
├── web/v1/                        # Веб-интерфейс версии v1
│   ├── index.tsx                 # Роуты и API для веб-версии
│   ├── default.page.vue          # Главная страница
│   └── serviceSettings.page.vue  # Страница настроек
└── telegram/v1/                   # Telegram miniapp версии v1
    ├── index.tsx                 # Роуты и API для Telegram
    ├── default.page.vue          # Главная страница (адаптирована для Telegram)
    └── serviceSettings.page.vue  # Страница настроек (адаптирована для Telegram)
```

## Система авторизации

**Версия:** 1.1.0  
Все страницы сервиса требуют обязательной авторизации.

### Методы аутентификации

Система поддерживает три способа входа:
1. **Email** - вход по электронной почте
2. **Телефон** - вход по номеру телефона
3. **Telegram** - вход через Telegram аккаунт

### Реализация

- Используется встроенная система авторизации Chatium
- Проверка авторизации: `requireRealUser(ctx)` из `@app/auth`
- Применяется ко всем роутам (страницы и API)

### Пользовательский интерфейс

**Элементы UI:**
- Информационная панель пользователя (имя, аватар)
- Кнопка выхода из системы
- Адаптивное расположение (desktop/mobile)

**Функциональность:**
- Выход через POST `/s/auth/sign-out`
- Отображение `ctx.user.displayName`

## Основные компоненты

### 1. Система логирования (Debug)

**Файл:** `lib/debug.lib.tsx`

Централизованная система логирования с поддержкой уровней:
- `info` - подробное логирование всех операций
- `warn` - предупреждения о некритичных проблемах
- `error` - ошибки без выброса исключений

**Использование:**
```typescript
Debug.configure({ level: 'info', prefix: '[ServiceName/filename]' });
Debug.info(ctx, 'Сообщение');
Debug.warn(ctx, 'Предупреждение');
Debug.error(ctx, 'Ошибка', 'E_CODE');
throw Debug.throw(ctx, 'Критическая ошибка', 'E_FATAL');
```

**Файл:** `lib/debug.repo.ts`

Утилиты для работы с настройками Debug:
- `getServiceName(ctx)` - получение названия сервиса из БД
- `getLogLevel(ctx)` - получение уровня логирования из БД
- `initDebug(ctx, filename)` - автоматическая инициализация Debug

### 2. Таблица настроек

**Файл:** `tables/v1/settings.table`

Хранит глобальные настройки сервиса:
- `serviceName` (string) - название сервиса для логирования
- `logLevel` (string) - уровень логирования: info/warn/error

### 3. Веб-интерфейс (web/v1)

**Роуты (требуют авторизации):**
- `GET /web/v1/` - главная страница
- `GET /web/v1/settings` - страница настроек
- `GET /web/v1/api/settings` - API получения настроек
- `POST /web/v1/api/settings` - API обновления настроек

**Страницы:**
- `default.page.vue` - отображает название сервиса, статус "В разработке",
  информацию о пользователе и кнопку выхода
- `serviceSettings.page.vue` - форма редактирования настроек

**Дизайн:** Градиентный фон (purple-blue), адаптивная верстка, современный UI

### 4. Telegram miniapp (telegram/v1)

**Роуты (требуют авторизации):**
- `GET /telegram/v1/` - главная страница
- `GET /telegram/v1/settings` - страница настроек  
- `GET /telegram/v1/api/settings` - API получения настроек
- `POST /telegram/v1/api/settings` - API обновления настроек

**Страницы:**
- `default.page.vue` - адаптирована под Telegram (использует CSS-переменные Telegram),
  отображает информацию о пользователе и кнопку выхода
- `serviceSettings.page.vue` - форма редактирования настроек с Telegram UI

**Особенности:**
- Инициализация Telegram WebApp API
- Использование цветовых тем Telegram
- Оптимизация для мобильных устройств
- Поддержка темной темы
- Font Awesome для иконок

### 5. Корневой роутер

**Файл:** `index.tsx`

Выполняет автоматический редирект на актуальную версию веб-интерфейса (`/web/v1/`).

**Безопасность:**
- Требует авторизации перед редиректом
- Использует `requireRealUser(ctx)`

## Логирование

Все исполняемые файлы включают подробное логирование:

**Инициализация:**
```typescript
await initDebug(ctx, 'filename');
```

**Логи:**
- Начало и конец операций (info)
- Получение/обновление данных (info)
- Предупреждения о некорректных данных (warn)
- Ошибки с кодами (error)

**Префиксы:**
- `[Miniapp Video Service/index]` - корневой файл
- `[Miniapp Video Service/web/v1/index]` - веб-интерфейс
- `[Miniapp Video Service/telegram/v1/index]` - Telegram miniapp

## API

### GET /web/v1/api/settings (и /telegram/v1/api/settings)

Получение настроек сервиса.

**Ответ:**
```json
{
  "serviceName": "Miniapp Video Service",
  "logLevel": "info"
}
```

### POST /web/v1/api/settings (и /telegram/v1/api/settings)

Обновление настроек сервиса.

**Тело запроса:**
```json
{
  "serviceName": "string",
  "logLevel": "info" | "warn" | "error"
}
```

**Валидация:**
- Все поля обязательны
- `logLevel` должен быть одним из: info, warn, error

## Версионирование

Проект использует версионирование на уровне каталогов:
- `/v1/` - первая версия API и интерфейса
- Будущие версии: `/v2/`, `/v3/` и т.д.

Это позволяет поддерживать несколько версий одновременно и обеспечивает обратную совместимость.

## Безопасность

**Авторизация:**
- Все страницы и API защищены
- Метод: `requireRealUser(ctx)` из `@app/auth`
- Поддержка трех способов входа (email, phone, Telegram)

**Контекст пользователя:**
- Доступен через `ctx.user`
- Поля: id, displayName, firstName, lastName, email, phone и др.

## Следующие шаги разработки

1. Добавление таблиц для хранения видео-записей
2. Реализация загрузки и хранения видео
3. Создание плеера для воспроизведения
4. API для управления видео
5. Система ролей и разрешений

## Технологии

- **Backend:** Chatium Framework
- **Frontend:** Vue 3 (Composition API)
- **Database:** Heap Tables
- **UI:** Native CSS с адаптацией под Telegram
- **Logging:** Custom Debug система
- **Auth:** Chatium встроенная авторизация
- **Icons:** Font Awesome 6.7.2