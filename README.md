# Neso Assistant

## Обзор
Neso Assistant — внутренний сервис, развёрнутый на low-code платформе Chatium и помогающий команде управлять данными о продуктах, тарифах, скидках и курсах валют. Серверная часть принимает вебхуки (в частности, из Notion), нормализует записи и сохраняет их в таблицах Heap, а веб-интерфейс предоставляет удобные таблицы для просмотра данных и настройки уровня логирования проекта. В качестве точки входа выступает редирект с корневого пути на веб-интерфейс `/web/v1`.【F:index.tsx†L1-L7】

## Архитектура и основные модули

### 1. REST API (папка `api/v1`)
Каждый эндпоинт реализован как Chatium route и использует общие вспомогательные библиотеки для логирования и чтения настроек. Маршруты проверяют валидность входных данных, синхронизируют записи с таблицами Heap и возвращают структурированные ответы.

| Эндпоинт | Назначение | Ключевые проверки/результат |
| --- | --- | --- |
| `GET /api/v1/getCurrencyCalc` | Конвертация указанной суммы в RUB, EUR и USD на основе актуального курса USD. Выполняется валидация параметров `currency` и `value`, обработка ошибок и возврат расширенного ответа с таймстампом.【F:api/v1/getCurrencyCalc.ts†L1-L158】 |
| `POST /api/v1/postCurrencyRate` | Получение webhook-записей с курсами валют, проверка `database_id`, наличие всех трёх значений (RUB/EUR/UAH) и сохранение или обновление строки в таблице курсов.【F:api/v1/postCurrencyRate.ts†L1-L95】 |
| `POST /api/v1/postProduct` | Приём данных о продукте: проверка идентификаторов, валюты, периодов и формата PID (`NA-Axxxx`). В зависимости от наличия записи создаёт или обновляет продукт в таблице `products`.【F:api/v1/postProduct.ts†L1-L142】 |
| `POST /api/v1/postTariff` | Синхронизация тарифов: проверка источника, PID, связанного продукта и цены. Автоматически подставляет валюту из продукта и обновляет запись тарифа.【F:api/v1/postTariff.ts†L1-L168】 |
| `POST /api/v1/postDiscount` | Управление скидками: связывает скидку с тарифом и продуктом, проверяет валюту, значение и интервалы действия, после чего создаёт или обновляет запись в таблице скидок.【F:api/v1/postDiscount.ts†L1-L157】 |

### 2. Веб-интерфейс (папка `web/v1`)
- Маршрут `webV1Route` подбирает нужную страницу по query-параметрам (`view`, `settings`) и рендерит Vue-компонент в обёртке с TailwindCSS. Стандартный вид переключается между страницами продуктов, тарифов, скидок, курсов и настройками.【F:web/v1/index.tsx†L1-L62】
- Домашняя страница отображает плитки-навигацию ко всем разделам и настройкам проекта.【F:web/v1/pages/DefaultPage.vue†L1-L49】
- Страницы `Products`, `Tariffs`, `Discounts`, `CurrencyRates` и `Settings` запрашивают данные через общие обработчики (см. ниже) и выводят таблицы/формы с состояниями загрузки и ошибками.【F:web/v1/pages/ProductsPage.vue†L1-L69】【F:web/v1/pages/TariffsPage.vue†L1-L58】【F:web/v1/pages/DiscountsPage.vue†L1-L74】【F:web/v1/pages/CurrencyRatesPage.vue†L1-L60】【F:web/v1/pages/SettingsPage.vue†L1-L75】

### 3. Клиентские обработчики данных (папка `web/v1/handlers`)

| Файл | Действие | Особенности |
| --- | --- | --- |
| `get-products.api.ts` | Читает из таблицы продуктов, сортирует по `pid` и логирует операции.【F:web/v1/handlers/get-products.api.ts†L1-L22】 |
| `get-tariffs.api.ts` | Возвращает список тарифов, отсортированный по `tid`.【F:web/v1/handlers/get-tariffs.api.ts†L1-L22】 |
| `get-discounts.api.ts` | Загружает скидки, упорядоченные по дате создания, для отображения в UI.【F:web/v1/handlers/get-discounts.api.ts†L1-L22】 |
| `get-currency-rates.api.ts` | Возвращает до 10 последних курсов валют.【F:web/v1/handlers/get-currency-rates.api.ts†L1-L21】 |
| `settings-heap.api.ts` | Позволяет прочитать или обновить уровень логирования; валидирует значения и создаёт дефолтную запись при отсутствии данных.【F:web/v1/handlers/settings-heap.api.ts†L1-L65】 |

### 4. Общие библиотеки (`lib`)
- `debug.lib.tsx` — централизованный логгер с уровнями `info/warn/error`, возможностью изменять префикс и автоматической записью в `ctx.log` и `ctx.account.log`. Пример использования включён прямо в файле.【F:lib/debug.lib.tsx†L1-L93】
- `getLogLevel.ts` — загружает уровень логирования из таблицы настроек и конфигурирует логгер перед обработкой запроса.【F:lib/getLogLevel.ts†L1-L31】
- `core/currency/convert.ts` — ядро расчётов: получает курс USD из таблицы, валидирует входные данные, конвертирует сумму в три валюты и отдаёт округлённый результат. Также предоставляет утилиту `getCurrentRates` для получения актуальных курсов.【F:lib/core/currency/convert.ts†L1-L270】

### 5. Таблицы Heap (`tables/v1`)
Данные хранятся в Heap-таблицах, описанных автогенерированными файлами. Каждая таблица задаёт структуру, типы полей и метаданные для поиска.
- `products.table.ts` — PID, спикер, менеджер, базовая цена, валюта и ключевые даты жизненного цикла продукта, а также флаг продажи записи.【F:tables/v1/products.table.ts†L1-L64】
- `tariffs.table.ts` — тарифы с идентификаторами TID, связью с продуктом и ценой.【F:tables/v1/tariffs.table.ts†L1-L28】
- `discounts.table.ts` — скидки для тарифов с датами начала и окончания действия.【F:tables/v1/discounts.table.ts†L1-L34】
- `currency_rates.table.ts` — курсы валют относительно USD (RUB, EUR, UAH).【F:tables/v1/currency_rates.table.ts†L1-L28】
- `settings.table.ts` — хранит уровень логирования (`logLevel`) для конфигурации проекта.【F:tables/v1/settings.table.ts†L1-L18】

## Поток данных
1. **Вебхуки из Notion (или других источников)** попадают в POST-эндпоинты API, где проверяются идентификаторы баз и нормализуются значения.
2. **Серверная логика** использует таблицы Heap для поиска/обновления записей и логирует шаги через `Debug` с префиксами, зависящими от модуля.
3. **Веб-интерфейс** читает данные через те же Heap API, визуализируя результаты в таблицах и предоставляя форму для смены уровня логирования.

## Настройка и эксплуатация
- **Платформа**: проект рассчитан на выполнение внутри Chatium, поэтому запуск и маршрутизация происходят в рамках инфраструктуры платформы.
- **Уровень логирования**: изменяется из интерфейса настроек, после чего новые значения автоматически подхватываются при следующих запросах через `initializeDebug`. Уровень хранится в таблице `settings` и по умолчанию равен `error`.【F:lib/getLogLevel.ts†L8-L20】【F:web/v1/handlers/settings-heap.api.ts†L11-L65】
- **Расширение API**: при добавлении новых вебхуков рекомендуется повторно использовать `initializeDebug` и следовать стилю валидации входных данных, показанному в существующих обработчиках.
- **UI-разделы**: новые страницы подключаются в `web/v1/index.tsx` и получают доступ к общим помощникам (`web/v1/lib`). Визуальное оформление опирается на TailwindCSS, подключённый глобально для веб-интерфейса.【F:web/v1/index.tsx†L38-L56】

## Дополнительные замечания
- Все маршруты помечены директивой `// @shared-route`, что позволяет переиспользовать их между сервером и клиентскими частями Chatium.
- Логика конвертации валют базируется на курсе USD; при отсутствии записи возвращается информативная ошибка, что позволяет контролировать полноту данных перед расчётами.【F:lib/core/currency/convert.ts†L152-L209】
- Компоненты UI учитывают состояния загрузки и ошибки, выводя дружелюбные сообщения без раскрытия внутренних деталей стека.

