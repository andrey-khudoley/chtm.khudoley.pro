# Miniapp Video Service - Архитектура проекта

**Версия:** 1.2.3  
**Дата обновления:** 2025-10-04  
**Статус:** В разработке  
**Что изменилось:** Исправлены критические проблемы после переноса проекта - пути импортов в watchVideo.page.vue и дополнены экспорты в pages/index.ts

## Описание

Сервис для отображения видео-записей внутри miniapp приложений Telegram с веб-версией для браузеров. Пользователи могут добавлять видео через iframe-код, управлять своей библиотекой видео и делиться ссылками для просмотра.

## Структура проекта

```
/
├── index.tsx                         # Корневой роут с редиректом на актуальную версию
├── lib/                              # Библиотеки и утилиты
│   ├── debug.lib.tsx                # Debug класс для логирования
│   └── debug.repo.ts                # Репозиторий для работы с настройками Debug
├── tables/v1/                        # База данных версии v1
│   ├── settings.table               # Таблица глобальных настроек сервиса
│   └── videos.table                 # Таблица видео пользователей
├── web/v1/                           # Веб-интерфейс версии v1
│   ├── index.tsx                    # Роуты и API для веб-версии
│   ├── pages/
│   │   ├── default.page.vue         # Главная страница с навигацией
│   │   ├── serviceSettings.page.vue # Страница настроек сервиса
│   │   ├── addVideo.page.vue        # Форма добавления видео
│   │   ├── videoList.page.vue       # Список видео пользователя
│   │   ├── index.ts                 # Реэкспорт роутов для удобного импорта
│   │   └── watchVideo.page.vue      # Страница просмотра видео (100% экрана)
└── telegram/v1/                      # Telegram miniapp версии v1
    ├── index.tsx                    # Роуты и API для Telegram
    └── pages/
        ├── default.page.vue         # Главная страница с навигацией
        ├── serviceSettings.page.vue # Страница настроек
        ├── addVideo.page.vue        # Форма добавления видео
        ├── videoList.page.vue       # Список видео пользователя
        ├── index.ts                 # Реэкспорт роутов для удобного импорта
        └── watchVideo.page.vue      # Страница просмотра видео (100% экрана)
```

## Правила импортов

**Версия:** 1.2.3  
Для обеспечения корректной работы после переноса проекта важно соблюдать следующие правила импортов:

### Vue-компоненты в папке pages/

Все Vue-компоненты, расположенные в `web/v1/pages/` и `telegram/v1/pages/`, должны импортировать роуты из родительской директории с использованием `../index`:

```javascript
// ✅ ПРАВИЛЬНО
import { indexRoute, addVideoRoute, getVideoByIdApiRoute } from '../index';

// ❌ НЕПРАВИЛЬНО
import { indexRoute, addVideoRoute, getVideoByIdApiRoute } from './index';
```

### Файлы pages/index.ts

Файлы `web/v1/pages/index.ts` и `telegram/v1/pages/index.ts` служат для реэкспорта всех необходимых роутов из родительского `index.tsx`. Это обеспечивает централизованную точку доступа к роутам для компонентов.

Эти файлы должны экспортировать все роуты страниц и API, которые могут понадобиться компонентам.


## Система авторизации

**Версия:** 1.2.0  
Большинство страниц сервиса требуют обязательной авторизации, за исключением страницы просмотра видео.

### Методы аутентификации

Система поддерживает три способа входа:
1. **Email** - вход по электронной почте
2. **Телефон** - вход по номеру телефона
3. **Telegram** - вход через Telegram аккаунт

### Реализация

- Используется встроенная система авторизации Chatium
- Проверка авторизации: `requireRealUser(ctx)` из `@app/auth`
- Применяется ко всем роутам, кроме `/watch/:id`
- Страница просмотра видео (`/watch/:id`) доступна без авторизации

### Пользовательский интерфейс

**Элементы UI:**
- Информационная панель пользователя (имя, аватар)
- Кнопка выхода из системы
- Адаптивное расположение (desktop/mobile)

**Функциональность:**
- Выход через POST `/s/auth/sign-out`
- Отображение `ctx.user.displayName`

## Основные компоненты

### 1. Система логирования (Debug)

**Файл:** `lib/debug.lib.tsx`

Централизованная система логирования с поддержкой уровней:
- `info` - подробное логирование всех операций
- `warn` - предупреждения о некритичных проблемах
- `error` - ошибки без выброса исключений

**Использование:**
```typescript
Debug.configure({ level: 'info', prefix: '[ServiceName/filename]' });
Debug.info(ctx, 'Сообщение');
Debug.warn(ctx, 'Предупреждение');
Debug.error(ctx, 'Ошибка', 'E_CODE');
throw Debug.throw(ctx, 'Критическая ошибка', 'E_FATAL');
```

**Файл:** `lib/debug.repo.ts`

Утилиты для работы с настройками Debug:
- `getServiceName(ctx)` - получение названия сервиса из БД
- `getLogLevel(ctx)` - получение уровня логирования из БД
- `initDebug(ctx, filename)` - автоматическая инициализация Debug

### 2. Таблицы базы данных

#### Таблица настроек (`tables/v1/settings.table`)

Хранит глобальные настройки сервиса:
- `serviceName` (string) - название сервиса для логирования
- `logLevel` (string) - уровень логирования: info/warn/error

#### Таблица видео (`tables/v1/videos.table`)

Хранит информацию о видео пользователей:
- `videoId` (string) - уникальный ID видео
- `embedUrl` (string) - URL для встраивания видео (из iframe src)
- `title` (string) - название видео
- `owner` (UserRefLinkKind) - ссылка на владельца видео
- `createdAt` (DateKind) - дата создания
- `updatedAt` (DateKind) - дата обновления

### 3. Веб-интерфейс (web/v1)

#### Роуты страниц

**Требуют авторизации:**
- `GET /web/v1/` - главная страница с навигацией
- `GET /web/v1/settings` - страница настроек сервиса
- `GET /web/v1/add-video` - форма добавления видео
- `GET /web/v1/my-videos` - список видео пользователя

**Без авторизации:**
- `GET /web/v1/watch/:id` - страница просмотра видео (полноэкранный режим)

#### API роуты

**Настройки:**
- `GET /web/v1/api/settings` - получение настроек (требует авторизации)
- `POST /web/v1/api/settings` - обновление настроек (требует авторизации)

**Видео:**
- `POST /web/v1/api/videos/add` - добавление видео (требует авторизации)
- `GET /web/v1/api/videos` - получение списка видео пользователя (требует авторизации)
- `POST /web/v1/api/videos/delete/:id` - удаление видео (требует авторизации)
- `GET /web/v1/api/videos/:id` - получение видео по ID (без авторизации)

#### Страницы

**default.page.vue** - Главная страница
- Карточки навигации к основным разделам
- "Добавить видео", "Мои видео", "Настройки"
- Градиентный дизайн с иконками

**addVideo.page.vue** - Форма добавления видео
- Поле "Название видео"
- Поле "Код iframe" (textarea)
- Автоматическое извлечение URL из iframe-кода
- Генерация videoId из URL или случайным образом
- Сообщения об успехе/ошибке
- Перенаправление на список после добавления

**videoList.page.vue** - Список видео
- Сетка видео с превью (iframe)
- Название каждого видео
- Кнопки "Смотреть" и "Удалить"
- Пустое состояние с призывом добавить первое видео
- Кнопка "Добавить видео" в заголовке

**watchVideo.page.vue** - Просмотр видео
- Полноэкранный iframe (100% ширины и высоты)
- Загрузка видео по параметру `?video=ID`
- Без дополнительных элементов UI
- Без требования авторизации

**serviceSettings.page.vue** - Настройки сервиса
- Форма редактирования настроек
- Поля: serviceName, logLevel
- Валидация данных

**Дизайн:** Градиентный фон (purple-blue), адаптивная верстка, современный UI

### 4. Telegram miniapp (telegram/v1)

#### Роуты страниц

**Требуют авторизации:**
- `GET /telegram/v1/` - главная страница с навигацией
- `GET /telegram/v1/settings` - страница настроек сервиса
- `GET /telegram/v1/add-video` - форма добавления видео
- `GET /telegram/v1/my-videos` - список видео пользователя

**Без авторизации:**
- `GET /telegram/v1/watch/:id` - страница просмотра видео (полноэкранный режим)

#### API роуты

Аналогичны веб-версии, но с префиксом `/telegram/v1/api/`

#### Страницы

Все страницы адаптированы под Telegram с использованием:
- CSS-переменных Telegram (`--tg-theme-*`)
- Telegram WebApp API
- Нативных диалогов Telegram (confirm, alert)
- Инициализации при монтировании компонента

**default.page.vue** - Главная страница
- Список навигации в стиле Telegram
- Анимированная иконка
- Адаптация под темную/светлую тему

**addVideo.page.vue** - Форма добавления видео
- Адаптированная форма в стиле Telegram
- Использование цветовой схемы мессенджера

**videoList.page.vue** - Список видео
- Вертикальный список видео
- Компактные карточки
- Использование Telegram диалогов для подтверждения удаления

**watchVideo.page.vue** - Просмотр видео
- Идентична веб-версии
- Полноэкранный режим

**serviceSettings.page.vue** - Настройки сервиса
- Форма в стиле Telegram

#### Особенности Telegram версии

- **Инициализация Telegram WebApp API** при загрузке каждой страницы
- **Запрос разрешения на отправку сообщений** ботом (`requestWriteAccess()`) на главной странице
- **Использование цветовых тем Telegram** для адаптации под светлую/темную тему
- **Оптимизация для мобильных устройств**
- **Поддержка темной темы** через `@media (prefers-color-scheme: dark)`
- **Font Awesome для иконок**

### 5. Корневой роутер

**Файл:** `index.tsx`

Выполняет автоматический редирект на актуальную версию веб-интерфейса (`/web/v1/`).

**Безопасность:**
- Требует авторизации перед редиректом
- Использует `requireRealUser(ctx)`

**Реализация:**
- Использует прямой редирект на строковый путь `/web/v1/` без импорта роута

## Логирование

Все исполняемые файлы включают подробное логирование:

**Инициализация:**
```typescript
await initDebug(ctx, 'filename');
```

**Логи:**
- Начало и конец операций (info)
- Получение/обновление данных (info)
- Предупреждения о некорректных данных (warn)
- Ошибки с кодами (error)

**Префиксы:**
- `[Miniapp Video Service/index]` - корневой файл
- `[Miniapp Video Service/web/v1/index]` - веб-интерфейс
- `[Miniapp Video Service/telegram/v1/index]` - Telegram miniapp

## API

### Настройки

#### GET /web/v1/api/settings (и /telegram/v1/api/settings)

Получение настроек сервиса. Требует авторизации.

**Ответ:**
```json
{
  "serviceName": "Miniapp Video Service",
  "logLevel": "info"
}
```

#### POST /web/v1/api/settings (и /telegram/v1/api/settings)

Обновление настроек сервиса. Требует авторизации.

**Тело запроса:**
```json
{
  "serviceName": "string",
  "logLevel": "info" | "warn" | "error"
}
```

**Валидация:**
- Все поля обязательны
- `logLevel` должен быть одним из: info, warn, error

### Видео

#### POST /web/v1/api/videos/add (и /telegram/v1/api/videos/add)

Добавление нового видео. Требует авторизации.

**Тело запроса:**
```json
{
  "title": "string",
  "iframeCode": "<iframe src=\"https://...\" frameborder=\"0\" allowfullscreen></iframe>"
}
```

**Обработка:**
- Извлечение `src` из iframe-кода с помощью regex
- Генерация `videoId` из URL (если есть паттерн `embeded~ID`) или случайным образом
- Сохранение в таблицу с привязкой к `ctx.user.id`

**Ответ при успехе:**
```json
{
  "success": true,
  "video": {
    "id": "...",
    "videoId": "...",
    "embedUrl": "...",
    "title": "...",
    "owner": "..."
  }
}
```

**Ответ при ошибке:**
```json
{
  "success": false,
  "error": "Описание ошибки"
}
```

#### GET /web/v1/api/videos (и /telegram/v1/api/videos)

Получение списка видео текущего пользователя. Требует авторизации.

**Фильтрация:**
- По `owner` (ID текущего пользователя)
- Сортировка по `createdAt` (desc)
- Лимит: 100 записей

**Ответ:**
```json
[
  {
    "id": "...",
    "videoId": "...",
    "embedUrl": "...",
    "title": "...",
    "owner": "...",
    "createdAt": "..."
  }
]
```

#### POST /web/v1/api/videos/delete/:id (и /telegram/v1/api/videos/delete/:id)

Удаление видео по ID. Требует авторизации.

**Проверки:**
- Видео существует
- Пользователь является владельцем видео

**Ответ:**
```json
{
  "success": true
}
```

#### GET /web/v1/api/videos/:id (и /telegram/v1/api/videos/:id)

Получение видео по ID. **Не требует авторизации.**

**Ответ:**
```json
{
  "id": "...",
  "videoId": "...",
  "embedUrl": "...",
  "title": "...",
  "owner": "...",
  "createdAt": "..."
}
```

Или `null`, если видео не найдено.

## Версионирование

Проект использует версионирование на уровне каталогов:
- `/v1/` - первая версия API и интерфейса
- Будущие версии: `/v2/`, `/v3/` и т.д.

Это позволяет поддерживать несколько версий одновременно и обеспечивает обратную совместимость.

## Безопасность

**Авторизация:**
- Большинство страниц и API защищены
- Метод: `requireRealUser(ctx)` из `@app/auth`
- Поддержка трех способов входа (email, phone, Telegram)
- Страница просмотра видео (`/watch/:id`) доступна без авторизации для возможности публичного шаринга

**Контроль доступа:**
- Пользователь видит только свои видео в списке
- Удалять видео может только владелец
- Проверка владельца перед удалением

**Контекст пользователя:**
- Доступен через `ctx.user`
- Поля: id, displayName, firstName, lastName, email, phone и др.

## Работа с iframe-кодом

### Формат поддерживаемого iframe

```html
<iframe src="https://muuvee.ru/embeded~Y0BK4WKi7VbatLySIMY0muuve?autoplay=0&muted=0&controls=1&showMuuveeLink=1&start=0" frameborder="0" allowfullscreen></iframe>
```

### Извлечение данных

1. **embedUrl** - извлекается из атрибута `src` с помощью regex: `/src="([^"]+)"/`
2. **videoId** - извлекается из URL с помощью regex: `/embeded~([^?]+)/`
   - Если паттерн не найден, генерируется случайный ID: `vid_${timestamp}_${random}`

### Пример обработки

```typescript
const iframeCode = '<iframe src="https://muuvee.ru/embeded~ABC123?..." frameborder="0" allowfullscreen></iframe>';
const srcMatch = iframeCode.match(/src="([^"]+)"/);
const embedUrl = srcMatch[1]; // "https://muuvee.ru/embeded~ABC123?..."

const videoIdMatch = embedUrl.match(/embeded~([^?]+)/);
const videoId = videoIdMatch[1]; // "ABC123"
```

## Следующие шаги разработки

1. ✅ Добавление таблиц для хранения видео-записей
2. ✅ Реализация добавления видео через iframe-код
3. ✅ Создание полноэкранного плеера для воспроизведения
4. ✅ API для управления видео (CRUD операции)
5. Система тегов и категорий
6. Поиск по видео
7. Статистика просмотров
8. Возможность шаринга в социальные сети

## Технологии

- **Backend:** Chatium Framework
- **Frontend:** Vue 3 (Composition API)
- **Database:** Heap Tables
- **UI:** Native CSS с адаптацией под Telegram
- **Logging:** Custom Debug система
- **Auth:** Chatium встроенная авторизация
- **Icons:** Font Awesome 6.7.2
- **Video:** Iframe embeds (Muuvee и другие платформы)